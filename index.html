<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">


<meta name='viewport' content='width=device-width,maximum-scale=1.0,initial-scale=1.0,user-scalable=no'/>
<meta name='format-detection' content='telephone=no'/>
<meta name='format-detection' content='address=no'>
<link rel="shortcut icon" href="favicon.png" type="image/x-icon">
<title>Небожители</title>


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Pangolin">

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
	window.Telegram.WebApp.ready();
	window.Telegram.WebApp.expand();
</script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ZzFX/2.29/ZzFX.micro.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>


<!-- Для теста во время разработки чтобы стили не кешировались. -->
<!-- Использовать <link rel="stylesheet" type="text/css" href="style.css"> -->
<script>
var cssFile = 'style.css';
var version = new Date().getTime(); // Используем текущее время как версию
$('<link>')
	.attr('rel', 'stylesheet')
	.attr('type', 'text/css')
	.attr('href', cssFile + '?v=' + version)
	.appendTo('head');
</script>


<style>


@font-face {
    font-family: 'RedSunset';
    src: url('Red Sunset Regular.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}

</style>



<style>
        /* Сброс стилей браузера по умолчанию - убрать отступы */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
</style>



<style>

.my-flex-cont {
 display: flex;
  flex-flow: row-reverse wrap-reverse;
 justify-content: center;
align-items: flex-start;
 align-content: flex-start;
 height:100% ;
 width:100%;
}
.my-flex-box {
 margin: 3px;
 padding: 10px 15px 10px 15px;
 flex: 0 1 auto;
 background:rgba(0,0,0,0.6);
 border:1px solid rgba(0,0,0,0.5);
 border-radius:2px;
 box-shadow: 0px 0px 0px 1px rgba(255, 255, 255, 0.2) inset;
 color:#fff;
 font-size:14px;
 color:#fff;
}

</style>


</head>
<body>
<center>




<button id="sendButton">Сообение</button>
<button id="bdButton">бд</button>
<div id="alert"></div>
<div id="result-id"></div>
	
<script>




const currentUrl = window.location.href;
const userId = new URL(currentUrl).searchParams.get('id');
document.getElementById('result-id').textContent = `Ваш ID: ${userId || 'не найден'}`;


const targetId = "jf7eded94kdmkjdek9kdw20dekcbq9mmx5sb3owl0sk5na7zvit8cvuer83mvgpemctysps7xm2s";
const myId = "8xkwM6zo0HzNRzixj19dmcpR5Ncow4ml2s7egp3dqZoB-" + userId; // Уникальный ID для текущего клиента

const peer = new Peer(myId);
let conn; // Объявляем conn глобально

peer.on('open', function(peerID) {
	console.log("Соединение открыто. Ваш ID: " + peerID);

	//подключение
	conn = peer.connect(targetId);
	// Обработка события открытия соединения
	conn.on('open', () => {
		console.log('Соединение открыто');
		if (conn && conn.open) {
			conn.send('OpenWeb');
		} else {
			console.error('Соединение не установлено или закрыто');
		}
	});
	// Обработка события закрытия соединения
	conn.on('close', () => {
		console.log('Соединение закрыто');
	});
	// Обработка ошибок
	conn.on('error', (err) => {
		console.error('Ошибка соединения:', err);
	});
});

peer.on('connection', function(connect) {

	connect.on('data', function(data) {
	
		console.log("Получено сообщение: " + data);
		//$("#alert").append("Получено сообщение: " + data + "<br>");
		
		// Разделяем строку по символу '|'
        const parts = data.split('|');

        // Проверка, есть ли первая часть и содержит ли она "move"
        if (parts.length > 0 && parts[0] === "move") {
            console.log("Данные перемещения: " + parts[1]);
			
			try {
                // Парсим JSON-строку
                const items = JSON.parse(parts[1]);

                // Создаем div для каждого элемента
				$(".my-flex-cont").empty();
                items.forEach(item => {
                    const div = $('<div>', {
                        name: "move",
                        xy: item.xy,
                        url: item.url,
                        class: "my-flex-box",
                        text: item.name
                    });
                    // Вставляем div в #alert
                    $(".my-flex-cont").append(div);
                });

            } catch (e) {
                console.error("Ошибка парсинга JSON: ", e);
            }
			
        }
		
		
	});
	
});

$('#sendButton').click(function() {
	if (conn && conn.open) {
		// Отправка сообщения (если нужно)
		conn.send('Привет!');
	} else {
		console.error('Соединение не установлено или закрыто');
	}
});

$('#bdButton').click(function() {
	if (conn && conn.open) {
		conn.send('db');
	} else {
		console.error('Соединение не установлено или закрыто');
	}
});




</script>






<div id='main' style='padding: 0px 0px 0px 0px; background:#000; width:360px;'>
<div id='content' style='position:relative; padding: 0px 0px 0px 0px;'>


 





<div id='main_pic' class='' style='margin: 0px 0px 0px 0px; background: url(result.png), #000; background-size:100% 100%; padding: 5px 5px 15px 5px; box-sizing:border-box; position:relative; height: 540px; width: 100%; z-index:2; background: url(301101661-512-k678445.jpg) no-repeat; background-size:100% 100%;'>

	<div id='t1' style='height: 40px; width: 40px; position:absolute; top:10px; left:10px; background:#000;'>1</div>
	<div id='t2' style='height: 40px; width: 40px; position:absolute; top:60px; left:10px; background:#000;'>2</div>
	<div id='t3' style='height: 40px; width: 40px; position:absolute; top:110px; left:10px; background:#000;'>3</div>
	
	<div id='obj' class=my-flex-cont></div>

</div>



<!-- ЖУРНАЛ -->
<div style='position:relative; width:100%; padding:5px; box-sizing:border-box; background:url(bg_content.png); background-size:100% auto; box-shadow: inset 0px 7px 5px -5px #000;'>
	<div id='journal' style='overflow:hidden; width:100%; height:300px; overflow-y:hidden; position:relative; '></div>
</div>
<script>	
var arr = ["Медведь грозно рычит и кидается в вашу сторону.", "Злая тварь укусила вас за ногу нанеся 12 урона.", "От удара лапы, медветь разрывает вашу кожу. 23 урона.", "Заяц убежал на запад.", "Медведь пытался наброситься, но вы вовремя увернулись."];
setInterval(function() {
  var randomIndex = Math.floor(Math.random() * arr.length);
  var randomText = arr[randomIndex];
  $("#journal").prepend("<div class='text_jrn' style='font-size:15px; text-align:center; color:#000; '>" + randomText + "</div>");
}, 500);

// Удаляем старые элементы, если их больше 3
setInterval(function() {
  var children = $("#journal").children();
  if (children.length > 3) {
    children.slice(3).remove();
  }
}, 500);
</script>



</div><!-- content -->
</div><!-- main -->



<script>

$('#t1').click(function() {

	$('#main_pic').html('<div style="height: 100%; width: 100%; position:absolute; top:0px; left:0px; background:url(rty.webp) repeat, rgba(0,0,0, 0.6);"></div>');

	$('#main_pic').append('<div style="position:absolute; top:10px; left:10px; right:10px; height:180px; border-radius:4px; border:1px solid #000; background:url(Screenshot_2.png), #000; background-size:100% 100%; background-position:center;"></div>  </div>');
	
});




//перемещение
$(document).on('click', 'div[name="move"]', function() {

	
	//DB("loc");
	
	
	//saveImgAndReadDB("loc");
	//exp_add_move();
	
	const move = $(this).attr("xy");
	console.log('move - ' + move);
	
	const newBackgroundUrl = $(this).attr('url');
	// Меняем фоновое изображение элемента с id="main_pic"
	$('#main_pic').css('background-image', `url('${newBackgroundUrl}')`);
	
	if (conn && conn.open) {
		conn.send('move|' + move);
	} else {
		console.error('Соединение не установлено или закрыто');
	}
	

});


//https://live.staticflickr.com/65535/54100502106_1623c2d141_b.jpg
//https://live.staticflickr.com/65535/54100756483_a61fca285f_b.jpg
//https://live.staticflickr.com/65535/54100841024_b5969c3502_b.jpg




</script>
























</center>
</body>
</html>
